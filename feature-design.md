# request

## 监听了组件外部事件

 - 需要监听 window 的变化来动态改变尺寸。
 - 需要监听全局 history
 - 监听键盘事件，必须知道自己的 focus 状态
 
### 问题

现在监听外部事件，例如 window 和 history 变化，是在 componentDidMount 中主动去监听的。然而有些渲染环境，全局需求可能会不一样。例如在某些移动页面不会有 resize 事件。
有的上层框架依赖了 history，需要和组件的 history 区分开。
  
### 方案

 - 组件不能获取全局，全局对象由框架注入
 - focus 状态？组件什么情况算是 focus?（实验）
 
## 需要获取全局信息
 
 - 需要在生命周期中对 ref 进行处理，通常是计算 dom 位置/大小。例如邮件菜单这种组件需要知道自己的绝对位置好决定向哪边弹出。
 - 需要获取全局或者指定容器的高度
 
### 问题

本质是因为 React 渲染是从顶到底的方式，如果父级元素依赖于底层信息，则必须在 didMount 中处理。位置信息仍然是相对的，如果我们要实现"不用 iframe来嵌套某些页面"，那么很容易出现定位错误问题。
但是如果组件内的环境是注入的而不是读取全局的，那么可以解决。

componentDidMount 中的任务分工仍然不够清晰，有的组件可能会发 ajax。是否应该提供一个单独的 api 来实现 dom 的操作

### 方案

 - 提供 componentDidPaint 来专门处理 dom 操作。componentDidMount 在 paint 之后。didPaint 中可以考虑如何注入 dom 信息。
  
## 需要调用时序相关全局 api

 - 需要有节流函数的能力，在节流中会用到全局的 requestAnimationFrame 或者 setTimeout
 - 用js来模拟动效，并作为事件触发来源
 - 可能会将 css 动画的周期也变成自己的事件触发来源
 
### 问题 

 对组件重绘的控制是否属于优化问题？ 
 如果属于优化问题，那么应该由框架来完成，或者用户在使用时能配置，开发者能在上层封装再处理。
 如果由框架完成或者用户在使用时配置，那么用户(框架)如何知道要对什么函数使用节流？因为用户注册的全局监听现在都是在 didMount 中主动监听。
 例如 addEventListener(window, 'resize') 这种方式，不是声明式。无法静态读出。
 
 js 模拟动效中可能会用到 setTimeout，如果不拆成两个声明阶段，很难实现对 react 的单步调试。react 的单步调试有必要吗？
 
 css 动画周期如何来管理，和 js 动效一样。这必须要 css-in-js 才能实现。
 
### 方案

 - 全局监听必须改成声明，这样就能知道监听了哪些全局事件，也就有可能框架层面进行节流并且可配置。
 - css 和组件内部的信号统统用 signal 来触发，这样能做外部控制，除此之外还能做什么？？？
 
## 其他

 - 作为 api 暴露给全局用的组件
 - 需要对外提供 onFocus 和 onBlur
 - 需要打包系统能支持动态 require，才能实现某些对环境有依赖的组件可以在服务器端渲染
 - 需要突破原本的 dom 结构，实现类似于全局 modal 的能力
 - 组件内的文字需要国际化
 - 组件关系(1. 上层和 children 约定的情况; 2. 组件内的功能切割，子组件，功能切割也有几种形式，自带数据的组件和绑在当前数据上的子组件，例如 table和 pagination)
 - 服务器端截图的能力, 提供 didPaint 回调 
 - 组件实现 immutable 的问题, 如何实现任意状态的回滚。
 
### 问题

 1. 全局暴露的 api 有两种，一种是操作组件内部的状态，例如 dialog，一种是作为命令式的全局 api 使用， 例如 focus、blur。
 3. 组件需要声明是否指定平台，由打包阶段进行动态替换。组件自身无需关注平台。
 4. 如何实现 datePicker 中的 modal。
 5. 国际化仍然需要字符串写成模板形式，因为除了具体的字符串之外，还可能出现 interpolation 中的 i18n。
 6. lego 组件内部直接使用 lego 子组件应该怎么处理 state？Row/Col 这种联系怎么处理？
 8. immutable 的 state 数据格式应该是怎样的？通过 children 嵌套的组件间如何组织？

### 方案

1. dialog 可以通过包装 util 实现。focus 和 blur 状态也可以附着在 appearance 上。
3. 组件在文件结构上声明不同的平台。
4. 类似于 transparent。组件知道 自己/Parent/Root/Screen 这四个概念。这样就存在合并 dialog 的可能。
5. 组件内部的利用的带 state 的数据在render时就翻译了，其中的 Text 组件可以拿着翻译后的数据再处理，这里的问题是 Text 拿到的数据具有句式，和 yahoo 的 i18n 集合需要完整的句式。
用户 stateTree 中的 interpolation 国际化可以由 util 处理。
6. 有几种情况：
  - 使用 children 作为 identifier 的，在使用时可以有 scope 也可以没有。如果组件不声明的话，除非 render 否则根本无法知道数据会怎么构造，这样会到值对用户代码做静态分析时只能分析到第一层。
  除非再对 render 代码做语法树分析。
  - 直接将 lego 组件 import 进来，作为功能子集使用。那么必须提供数据挂载点。(可能出现阻抗不匹配)
  - 组件跟组件之间有特殊约定，例如 Row/Col，全部变成 identifier 的形式？变成这种形式未来才方便做(拖拽!，变成占位符)。
8. 目前只要考虑对象和数组的表现形式是怎样的，再看一下主要的几个组件会需要什么样的数据。只要为无限自循环的结构提供一种表示方法即可。


## 原始

 - 需要在声明周期中对 ref 进行处理，通常是计算 dom 位置/大小。
 - 需要监听 window 的变化来动态改变尺寸。
 - 需要有节流函数的能力，在节流中会用到全局的 requestAnimationFrame 或者 setTimeout
 - 可能会将 css 动画的周期也变成自己的事件触发来源
 - 需要监听全局 history
 - 需要对外提供 onFocus 和 onBlur
 - 需要获取全局或者指定容器的高度
 - 用js来模拟动效，并作为事件触发来源
 - 组件内的文字需要国际化
 - 需要突破原本的 dom 结构，实现类似于全局 modal 的能力
 - 组件关系(1. 上层和 children 约定的情况; 2. 组件内的功能切割，子组件)
 - 作为 api 暴露给全局用的组件
 - 监听键盘事件，必须知道自己的 focus 状态
 - 需要打包系统能支持动态 require，才能实现某些对环境有依赖的组件可以在服务器端渲染
 
 - 服务器端截图的能力, 提供 didPaint 回调 
 - 组件实现 immutable 的问题

# 设计架构时的问题

 - appearance 的存在的意义？即使是国际化，有没有必要通过保存实例的方式来设计？
 - 
 
# state 和 props 阻抗不匹配的情况

 
